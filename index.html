<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prot√≥tipo - Mapa de Medica√ß√µes Completo (Responsivo)</title>
    <style>
        /* Estilos BASE (Desktop/Tablet) */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1300px; 
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h2 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .header-controls button {
            background-color: #ffc107;
            color: #333;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .info-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: flex-start; 
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9f5ff;
            border-radius: 4px;
        }
        .input-group {
            display: flex;
            align-items: center;
            margin-right: 20px; 
            margin-bottom: 10px; 
        }
        .input-group label {
            font-weight: bold;
            margin-right: 10px;
            white-space: nowrap; /* Impede que o label quebre */
        }
        .input-group input, .input-group select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .input-group input[type="number"] {
            width: 60px;
        }
        .input-group input[type="time"] {
            width: 80px;
        }
        .periodo-analisado {
            flex-basis: 100%; 
            margin-top: 10px;
            font-style: italic;
            font-size: 0.9em;
            color: #555;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        /* --- Tabela de Medica√ß√µes (Scroll para Mobile) --- */
        .tabela-wrapper {
            overflow-x: auto; /* Permite scroll horizontal na tabela */
        }
        .tabela-medicacao {
            min-width: 900px; /* Garante que a tabela tenha uma largura m√≠nima para o scroll */
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .tabela-medicacao th, .tabela-medicacao td {
            border: 1px solid #ddd;
            padding: 8px; 
            text-align: left;
            font-size: 0.9em;
            white-space: nowrap; /* Impede que o conte√∫do das c√©lulas quebre */
        }
        .tabela-medicacao th {
            background-color: #007bff;
            color: white;
            font-weight: normal;
            position: sticky;
            top: 0;
        }
        /* Estilos de Status (Mantidos) */
        #historicoTable th { background-color: #6c757d; color: white; }
        .horario-principal { background-color: #f1f8ff; font-weight: bold; text-align: center; vertical-align: middle; font-size: 1em; width: 7%; }
        .alerta-risco { background-color: #ffdddd !important; border-left: 5px solid red; }
        .alerta-texto { color: red; font-weight: bold; }
        .status-administrado { background-color: #c3e6cb; color: #155724; font-weight: bold; text-align: center; }
        .status-dispensado { background-color: #d1ecf1; color: #0c5460; font-weight: bold; text-align: center; font-size: 0.8em; }
        .status-checado { background-color: #ffeb3b; color: #333; font-weight: bold; text-align: center; font-size: 0.8em; }
        .checado-hora { font-size: 0.8em; font-weight: normal; display: block; margin-bottom: 5px; }
        .historico-header { margin-top: 25px; margin-bottom: 10px; color: #6c757d; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }


        /* --- MEDIA QUERIES PARA MOBILE (smartphones e tablets pequenos) --- */
        @media (max-width: 768px) {
            body {
                margin: 10px;
            }
            .container {
                padding: 10px;
            }
            h2 {
                font-size: 1.2em;
                text-align: center;
            }
            .header-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .header-controls button {
                width: 100%;
                margin-top: 10px;
            }

            /* Otimiza√ß√£o da barra de filtros */
            .info-header {
                flex-direction: column; /* Empilha os filtros verticalmente */
            }
            .input-group {
                width: 100%;
                margin-right: 0;
                margin-bottom: 8px;
                flex-wrap: nowrap;
            }
            .input-group label {
                flex-shrink: 0; /* Impede o label de encolher */
                min-width: 80px; /* Garante espa√ßo m√≠nimo para labels */
            }
            .input-group input, .input-group select {
                flex-grow: 1; /* Faz os campos de input/select preencherem o resto da linha */
                max-width: none;
            }

            /* Ajuste espec√≠fico para a tabela de Hist√≥rico em Mobile */
            #historicoTable {
                min-width: 700px; /* Garante o scroll */
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-controls">
        <h2>üìã Mapa de Medica√ß√µes - Prot√≥tipo Farmac√™utico</h2>
        <button onclick="abrirModalRelatorio()">üìä Gerar Relat√≥rio de Solicita√ß√µes</button>
    </div>

    <div class="info-header">
        
        <div class="input-group">
            <label for="paciente-select">Paciente:</label> 
            <select id="paciente-select" onchange="renderizarMapa()">
                <option value="P73491">73491 (Jos√© da Silva)</option>
                <option value="P80020">80020 (Maria Santos)</option>
                <option value="P91010">91010 (Pedro Alves)</option>
                <option value="P12345">12345 (Ana Costa)</option>
                <option value="all" selected>Todos os Pacientes</option>
            </select>
        </div>
        
        <div class="input-group">
            <label>Profissional:</label> <span id="adminName">Dr. Jo√£o Silva (Farma)</span>
        </div>

        <div class="input-group">
            <label for="data-alvo">Data Inicial:</label> 
            <input type="date" id="data-alvo" value="2025-12-04" onchange="renderizarMapa()">
        </div>
        
        <div class="input-group">
            <label for="hora-inicio">Hora Inicial:</label> 
            <input type="time" id="hora-inicio" value="00:00" onchange="renderizarMapa()">
        </div>
        
        <div class="input-group">
            <label for="horas-periodo">Per√≠odo (H):</label> 
            <input type="number" id="horas-periodo" value="6" min="1" max="24" onchange="renderizarMapa()">
        </div>

        <div class="input-group">
            <label for="via-filtro">Via:</label>
            <select id="via-filtro" onchange="renderizarMapa()">
                <option value="all" selected>Todas as Vias</option>
                <option value="Oral">Oral</option>
                <option value="IV">Intravenosa (IV)</option>
                <option value="SC">Subcut√¢nea (SC)</option>
                <option value="Outras">Outras</option>
            </select>
        </div>
        
        <div class="input-group">
            <label for="status-filtro">Status:</label>
            <select id="status-filtro" onchange="renderizarMapa()">
                <option value="all" selected>Todos</option>
                <option value="dispensado">Dispensados</option>
                <option value="checado">Checados</option>
                <option value="administrado">Administrados</option>
                <option value="pending">Pendentes</option>
            </select>
        </div>
        
        <div class="periodo-analisado">
            Per√≠odo analisado: <span id="periodoDisplay">...</span>
        </div>
    </div>
    
    <h3 class="historico-header">üîô Hist√≥rico de Doses Anteriores (Doses Administradas)</h3>
    <div class="tabela-wrapper"> <table class="tabela-medicacao" id="historicoTable">
            <thead>
                <tr>
                    <th style="width: 10%;">üìÖ Data/Hora</th>
                    <th style="width: 15%;">Paciente</th>
                    <th style="width: 30%;">üíä Medicamento</th>
                    <th style="width: 15%;">A√ß√£o Realizada</th>
                    <th style="width: 30%;">Detalhes (Profissional/Observa√ß√£o)</th>
                </tr>
            </thead>
            <tbody id="historicoTbody">
                </tbody>
        </table>
    </div>
    
    <hr>
    
    <h3 style="margin-top: 20px; color: #007bff;">‚è≥ Mapa de Doses Futuras / Presentes</h3>
    <div class="tabela-wrapper"> <table class="tabela-medicacao" id="mapaTabela">
            <thead>
                <tr>
                    <th>‚è∞ Hor√°rio</th>
                    <th>Paciente</th>
                    <th>üíä Medicamento</th>
                    <th>‚öñÔ∏è Dose</th>
                    <th>üíâ Via</th>
                    <th style="width: 18%;">‚ö†Ô∏è Alerta / Obs.</th>
                    <th style="width: 10%;">üì¶ Dispensado</th>
                    <th style="width: 15%;">‚úÖ Administrar (Checagem)</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <p style="margin-top: 20px;" id="statusMessage"></p>
</div>

<div id="relatorioModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="fecharModalRelatorio()">&times;</span>
    <h3>Configura√ß√£o de Relat√≥rio de Solicita√ß√µes</h3>
    <p>Em uma aplica√ß√£o real, voc√™ configuraria filtros (data, tipo de solicita√ß√£o, paciente) e o Back-end geraria um arquivo.</p>
    <p><strong>A√ß√£o Simulada:</strong> Seria gerado um arquivo CSV/PDF.</p>
    <button onclick="simularGeracao()">Gerar Relat√≥rio e Baixar</button>
  </div>
</div>

<script>
    // Armazena o status da administra√ß√£o para persistir entre os filtros
    let registros = {}; 
    
    // --- STATUS POSS√çVEIS ---
    const STATUS = {
        PENDENTE: 'PENDENTE',
        DISPENSADO: 'DISPENSADO', 
        CHECADO: 'CHECADO',
        ADMINISTRADO: 'ADMINISTRADO'
    };
    
    // --- SIMULA√á√ÉO DE DADOS HIST√ìRICOS ---
    const dosesHistoricasSimuladas = [
        { data: "2025-12-03", horario: "08:00", pacienteId: "P73491", nomeCompleto: "Jos√© da Silva", medicamentoNome: "AAS", dosagem: "100 mg", acao: STATUS.ADMINISTRADO, admin: "Enf. Ana", obs: "Dose di√°ria." },
        { data: "2025-12-03", horario: "12:00", pacienteId: "P80020", nomeCompleto: "Maria Santos", medicamentoNome: "Paracetamol", dosagem: "750 mg", acao: STATUS.ADMINISTRADO, admin: "Enf. Ana", obs: "Por febre (38¬∞C)." },
        { data: "2025-12-02", horario: "22:00", pacienteId: "P12345", nomeCompleto: "Ana Costa", medicamentoNome: "Sinvastatina", dosagem: "40 mg", acao: STATUS.ADMINISTRADO, admin: "Enf. Bia", obs: "Rotina." },
        { data: "2025-12-02", horario: "06:00", pacienteId: "P91010", nomeCompleto: "Pedro Alves", medicamentoNome: "Insulina", dosagem: "10 UI", acao: STATUS.DISPENSADO, admin: "Farma. Clara", obs: "Dose dispensada, mas n√£o administrada." },
    ];


    // --- SIMULA√á√ÉO DA RESPOSTA DO BACK-END (Expandida) ---
    const mapaSimuladoCompleto = [
        // --- 06:00 ---
        {
            horario: "06:00",
            administracoes: [
                { id: 106, pacienteId: "P73491", nomeCompleto: "Jos√© da Silva", medicamentoNome: "Insulina NPH", dosagem: "15 UI", viaAdministracao: "SC", observacoes: "Ajustar conforme glicemia", prescricaoId: "P006" },
                { id: 301, pacienteId: "P91010", nomeCompleto: "Pedro Alves", medicamentoNome: "Cefazolina", dosagem: "1g", viaAdministracao: "IV", observacoes: "Primeira dose pr√©-operat√≥ria.", prescricaoId: "P301" },
            ]
        },
        // --- 08:00 ---
        {
            horario: "08:00",
            administracoes: [
                { id: 201, pacienteId: "P80020", nomeCompleto: "Maria Santos", medicamentoNome: "Morfina", dosagem: "2 mg", viaAdministracao: "IV", observacoes: "Alto Risco / Dor", prescricaoId: "P101", alerta: { tipo: "Vigil√¢ncia", mensagem: "Medicamento de Alta Vigil√¢ncia (Checagem Dupla)." } },
                { id: 401, pacienteId: "P12345", nomeCompleto: "Ana Costa", medicamentoNome: "Amlodipino", dosagem: "10 mg", viaAdministracao: "Oral", observacoes: "Aferir PA antes de administrar.", prescricaoId: "P401" },
            ]
        },
        // --- 09:20 ---
        {
            horario: "09:20",
            administracoes: [
                { id: 102, pacienteId: "P73491", nomeCompleto: "Jos√© da Silva", medicamentoNome: "AAS", dosagem: "100 mg", viaAdministracao: "Oral", observacoes: "Nenhum Alerta", prescricaoId: "P002" },
                { 
                    id: 103, pacienteId: "P73491", nomeCompleto: "Jos√© da Silva", medicamentoNome: "Metformina", dosagem: "850 mg", viaAdministracao: "Oral", observacoes: "Administrar ap√≥s o caf√© da manh√£.", 
                    prescricaoId: "P003",
                    alerta: { tipo: "Intera√ß√£o", mensagem: "Risco de acidose l√°tica se contraste iodado for administrado." }
                },
            ]
        },
        // --- 12:00 ---
        {
            horario: "12:00",
            administracoes: [
                { id: 202, pacienteId: "P80020", nomeCompleto: "Maria Santos", medicamentoNome: "Paracetamol", dosagem: "750 mg", viaAdministracao: "Oral", observacoes: "Se febre > 37.8¬∞C", prescricaoId: "P102" },
                { id: 402, pacienteId: "P12345", nomeCompleto: "Ana Costa", medicamentoNome: "Dipirona", dosagem: "1g", viaAdministracao: "IV", observacoes: "Se dor ou febre.", prescricaoId: "P402" },
            ]
        },
        // --- 15:30 --- 
        {
            horario: "15:30",
            administracoes: [
                { id: 302, pacienteId: "P91010", nomeCompleto: "Pedro Alves", medicamentoNome: "Vancomicina", dosagem: "1.5g", viaAdministracao: "IV", observacoes: "Dose alta! Checar n√≠vel s√©rico.", 
                    prescricaoId: "P302", 
                    alerta: { tipo: "Dose Alta", mensagem: "Dose de 1.5g est√° acima do padr√£o para o peso do paciente (Verificar N√≠vel S√©rico)." }
                },
            ]
        },
        // --- 18:00 ---
        {
            horario: "18:00",
            administracoes: [
                { id: 105, pacienteId: "P73491", nomeCompleto: "Jos√© da Silva", medicamentoNome: "Contraste Iodado", dosagem: "100 ml", viaAdministracao: "IV", observacoes: "Administrar SOMENTE se Metformina suspensa.", prescricaoId: "P005" },
                { id: 203, pacienteId: "P80020", nomeCompleto: "Maria Santos", medicamentoNome: "Omeprazol", dosagem: "20 mg", viaAdministracao: "Oral", observacoes: "Antes da janta.", prescricaoId: "P103" },
            ]
        },
        // --- 22:00 --- 
        {
            horario: "22:00",
            administracoes: [
                { id: 403, pacienteId: "P12345", nomeCompleto: "Ana Costa", medicamentoNome: "Sinvastatina", dosagem: "40 mg", viaAdministracao: "Oral", observacoes: "Administrar ao deitar.", prescricaoId: "P403" },
            ]
        }
    ];
    
    // --- L√ìGICA DE DATAS E FILTRAGEM ---

    const formatarData = (dataObj) => {
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        return dataObj.toLocaleDateString('pt-BR', options);
    };
    
    function atualizarPeriodoDisplay(dataInicialStr, horaInicioStr, horas) {
        const dataHoraInicial = new Date(`${dataInicialStr}T${horaInicioStr}:00`);
        const dataFinalMs = dataHoraInicial.getTime() + (horas * 60 * 60 * 1000) - 1; 
        const dataFinal = new Date(dataFinalMs);
        
        const dataInicialFormatada = dataHoraInicial.toLocaleDateString('pt-BR', { day: 'numeric', month: 'numeric' });
        const horaInicialFormatada = dataHoraInicial.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const dataFinalFormatada = dataFinal.toLocaleDateString('pt-BR', { day: 'numeric', month: 'numeric' });
        const horaFinalFormatada = dataFinal.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        
        const periodoTexto = 
            `De ${dataInicialFormatada} √†s **${horaInicialFormatada}** at√© ${dataFinalFormatada} √†s **${horaFinalFormatada}** (${horas} horas)`;
            
        document.getElementById('periodoDisplay').innerHTML = periodoTexto;
    }

    // Filtra Doses Futuras/Presentes
    function filtrarMapa(pacienteIdFiltro, viaFiltro, statusFiltro, dataAlvoStr, horaInicioStr, horasPeriodo) {
        const mapaAgrupado = {};
        
        const dataHoraInicio = new Date(`${dataAlvoStr}T${horaInicioStr}:00`);
        const dataHoraFim = new Date(dataHoraInicio.getTime() + (horasPeriodo * 60 * 60 * 1000));

        mapaSimuladoCompleto.forEach(grupoHorario => {
            const dataHoraPrescricao = new Date(`${dataAlvoStr}T${grupoHorario.horario}:00`);
            
            // L√≥gica de 24h: se o hor√°rio for anterior ao filtro, considera o dia seguinte
            if (dataHoraPrescricao.getTime() < dataHoraInicio.getTime() && horaInicioStr !== '00:00') {
                dataHoraPrescricao.setDate(dataHoraPrescricao.getDate() + 1);
            }

            if (dataHoraPrescricao.getTime() >= dataHoraInicio.getTime() && dataHoraPrescricao.getTime() < dataHoraFim.getTime()) {
                
                grupoHorario.administracoes.forEach(item => {
                    let deveIncluir = true;
                    
                    const itemStatus = registros[item.id] ? registros[item.id].status : STATUS.PENDENTE;
                    item.status = itemStatus;
                    
                    if (pacienteIdFiltro !== 'all' && item.pacienteId !== pacienteIdFiltro) { deveIncluir = false; }
                    if (viaFiltro !== 'all') {
                        if (viaFiltro === 'Outras') {
                            if (['Oral', 'IV', 'SC'].includes(item.viaAdministracao)) { deveIncluir = false; }
                        } else if (item.viaAdministracao !== viaFiltro) { deveIncluir = false; }
                    }
                    if (statusFiltro === 'dispensado' && itemStatus !== STATUS.DISPENSADO && itemStatus !== STATUS.CHECADO && itemStatus !== STATUS.ADMINISTRADO) { deveIncluir = false; } 
                    else if (statusFiltro === 'checado' && itemStatus !== STATUS.CHECADO && itemStatus !== STATUS.ADMINISTRADO) { deveIncluir = false; } 
                    else if (statusFiltro === 'administrado' && itemStatus !== STATUS.ADMINISTRADO) { deveIncluir = false; } 
                    else if (statusFiltro === 'pending' && itemStatus !== STATUS.PENDENTE) { deveIncluir = false; }

                    if (deveIncluir) {
                        const chaveHorario = grupoHorario.horario;
                        if (!mapaAgrupado[chaveHorario]) {
                            mapaAgrupado[chaveHorario] = { horario: chaveHorario, administracoes: [] };
                        }
                        mapaAgrupado[chaveHorario].administracoes.push(item);
                    }
                });
            }
        });

        return Object.values(mapaAgrupado).sort((a, b) => {
            const timeA = a.horario.split(':').map(Number);
            const timeB = b.horario.split(':').map(Number);
            if (timeA[0] !== timeB[0]) return timeA[0] - timeB[0];
            return timeA[1] - timeB[1];
        });
    }

    // --- RENDERIZA√á√ÉO DO HIST√ìRICO (Mantida) ---
    function renderizarHistorico(pacienteIdFiltro) {
        const tbody = document.getElementById('historicoTbody');
        tbody.innerHTML = '';
        
        let dosesFiltradas = dosesHistoricasSimuladas.filter(dose => 
            pacienteIdFiltro === 'all' || dose.pacienteId === pacienteIdFiltro
        );
        
        if (dosesFiltradas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; font-style: italic; color: #777;">Nenhum registro hist√≥rico encontrado para este paciente.</td></tr>';
            return;
        }

        dosesFiltradas.forEach(dose => {
            const tr = document.createElement('tr');
            
            let statusText;
            let statusClass;

            if (dose.acao === STATUS.ADMINISTRADO) {
                statusText = '‚úÖ Administrado';
                statusClass = 'status-administrado';
            } else if (dose.acao === STATUS.DISPENSADO) {
                statusText = 'üì¶ Dispensado';
                statusClass = 'status-dispensado';
            } else {
                statusText = dose.acao;
                statusClass = '';
            }

            tr.innerHTML = `
                <td>${dose.data.split('-').reverse().join('/')} ${dose.horario}</td>
                <td>${dose.pacienteId.substring(1)} (${dose.nomeCompleto.split(' ')[0]})</td>
                <td>${dose.medicamentoNome} ${dose.dosagem}</td>
                <td class="${statusClass}">${statusText}</td>
                <td>${dose.admin}: ${dose.obs}</td>
            `;
            tbody.appendChild(tr);
        });
    }


    // --- A√á√ïES DE FLUXO DE TRABALHO (Mantida) ---

    function registrarAcao(idDose, acao) {
        const nomeItem = encontrarItemPorId(idDose).medicamentoNome;
        const adminName = document.getElementById('adminName').textContent;
        const dataHora = new Date().toLocaleTimeString();
        let novoStatus;

        if (acao === 'DISPENSAR') {
            novoStatus = STATUS.DISPENSADO;
            alert(`Confirma a DISPENSA de ${nomeItem}?`);
        } else if (acao === 'CHECAR') {
            novoStatus = STATUS.CHECADO;
            alert(`Confirma a checagem (preparo) de ${nomeItem} √†s ${dataHora}?`);
        } else if (acao === 'ADMINISTRAR') {
            novoStatus = STATUS.ADMINISTRADO;
            
            const itemRegistro = registros[idDose];

            if (!itemRegistro || (itemRegistro.status !== STATUS.CHECADO && itemRegistro.status !== STATUS.DISPENSADO)) {
                 if (!confirm(`ATEN√á√ÉO: ${nomeItem} n√£o foi checado. Deseja registrar a administra√ß√£o diretamente?`)) {
                    return;
                }
            } else if (!confirm(`Confirma a ADMINISTRA√á√ÉO de ${nomeItem}?`)) {
                return;
            }
        } else {
            return;
        }

        registros[idDose] = {
            status: novoStatus,
            admin: adminName,
            dataHora: dataHora
        };
        
        document.getElementById('statusMessage').innerHTML = 
            `<span style="color: ${novoStatus === STATUS.ADMINISTRADO ? 'green' : 'blue'};">‚úÖ Status **${novoStatus}** de **${nomeItem}** registrado √†s ${dataHora} por ${adminName}.</span>`;
        
        renderizarMapa(); 
    }

    function encontrarItemPorId(id) {
        for (const grupo of mapaSimuladoCompleto) {
            for (const item of grupo.administracoes) {
                if (item.id === id) {
                    return item;
                }
            }
        }
        return null;
    }

    function renderizarMapa() {
        const dataAlvo = document.getElementById('data-alvo').value;
        const horaInicio = document.getElementById('hora-inicio').value;
        const horasPeriodo = parseInt(document.getElementById('horas-periodo').value) || 6; 
        const pacienteIdFiltro = document.getElementById('paciente-select').value;
        const viaFiltro = document.getElementById('via-filtro').value;
        const statusFiltro = document.getElementById('status-filtro').value; 

        atualizarPeriodoDisplay(dataAlvo, horaInicio, horasPeriodo);
        
        // 1. Renderiza o Hist√≥rico
        renderizarHistorico(pacienteIdFiltro);

        // 2. Filtra e Renderiza o Mapa Atual/Futuro
        const mapaRenderizado = filtrarMapa(pacienteIdFiltro, viaFiltro, statusFiltro, dataAlvo, horaInicio, horasPeriodo);

        const tbody = document.querySelector('#mapaTabela tbody');
        tbody.innerHTML = ''; 

        if (mapaRenderizado.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nenhuma medica√ß√£o programada que corresponda aos filtros de tempo e paciente.</td></tr>';
            return;
        }

        mapaRenderizado.forEach(grupoHorario => {
            grupoHorario.administracoes.forEach((item, index) => {
                const tr = document.createElement('tr');
                
                if (item.alerta) {
                    tr.classList.add('alerta-risco');
                }
                
                if (index === 0) {
                    const tdHorario = document.createElement('td');
                    tdHorario.rowSpan = grupoHorario.administracoes.length;
                    tdHorario.classList.add('horario-principal');
                    tdHorario.textContent = grupoHorario.horario;
                    tr.appendChild(tdHorario);
                }

                tr.innerHTML += `
                    <td>${item.pacienteId.substring(1)} (${item.nomeCompleto.split(' ')[0]})</td>
                    <td>${item.medicamentoNome}</td>
                    <td>${item.dosagem}</td>
                    <td>${item.viaAdministracao}</td>
                    <td class="${item.alerta ? 'alerta-texto' : ''}">
                        ${item.alerta ? `‚ö†Ô∏è ${item.alerta.tipo}: ${item.alerta.mensagem}` : item.observacoes}
                    </td>
                `;

                // Coluna DISPENSADO
                const tdDispensa = document.createElement('td');
                
                if (item.status === STATUS.PENDENTE) {
                    tdDispensa.innerHTML = `<button class="btn-acao" style="background-color:#007bff;" onclick="registrarAcao(${item.id}, 'DISPENSAR')">Dispensar</button>`;
                } else {
                    tdDispensa.className = 'status-dispensado';
                    tdDispensa.textContent = `Disp. ${registros[item.id] ? registros[item.id].dataHora : ''}`;
                }
                tr.appendChild(tdDispensa);


                // Coluna ADMINISTRAR (CHECAGEM/STATUS FINAL)
                const tdAdministracao = document.createElement('td');
                tdAdministracao.style.textAlign = 'center';
                
                if (item.status === STATUS.PENDENTE) {
                    tdAdministracao.className = 'status-pendente';
                    tdAdministracao.textContent = 'Aguardando Dispensa';
                } else if (item.status === STATUS.DISPENSADO) {
                    tdAdministracao.innerHTML = `<button class="btn-acao" style="background-color:#ffc107; color: #333;" onclick="registrarAcao(${item.id}, 'CHECAR')">Checar</button>`;
                } else if (item.status === STATUS.CHECADO) {
                    tdAdministracao.className = 'status-checado';
                    const horaChecagem = registros[item.id] ? registros[item.id].dataHora : '';
                    tdAdministracao.innerHTML = 
                        `<span class="checado-hora">Checado √†s ${horaChecagem}</span>` + 
                        `<button class="btn-acao" style="background-color:#28a745;" onclick="registrarAcao(${item.id}, 'ADMINISTRAR')">Administrar</button>`;
                } else if (item.status === STATUS.ADMINISTRADO) {
                    tdAdministracao.className = 'status-administrado';
                    tdAdministracao.textContent = `Administrado (${registros[item.id] ? registros[item.id].dataHora : ''})`;
                }
                tr.appendChild(tdAdministracao);
                
                tbody.appendChild(tr);
            });
        });
    }

    // --- L√ìGICA DO MODAL (Mantida) ---
    function abrirModalRelatorio() { document.getElementById('relatorioModal').style.display = "block"; }
    function fecharModalRelatorio() { document.getElementById('relatorioModal').style.display = "none"; }
    function simularGeracao() { alert("Simula√ß√£o de Gera√ß√£o: Arquivo de Relat√≥rio (CSV/PDF) gerado com sucesso!"); fecharModalRelatorio(); }
    window.onclick = function(event) {
      const modal = document.getElementById('relatorioModal');
      if (event.target == modal) { fecharModalRelatorio(); }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const horaAtual = `${hours}:${minutes}`;
        document.getElementById('hora-inicio').value = horaAtual;
        renderizarMapa();
    });
</script>

</body>
</html>
